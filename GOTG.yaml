apiVersion: v1
kind: Namespace
metadata:
  name: cortex-xdr
  labels:
    app.kubernetes.io/name: cortex-xdr
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/warn: privileged
    pod-security.kubernetes.io/audit: privileged
---

apiVersion: v1
kind: Secret
metadata:
  name: xdr-agent-deployment
  namespace: cortex-xdr
type: Opaque
stringData:
  distribution-id: "66f6859e8e0a49478fb4b99ee15cf546"

---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: xdr-agent-user
  namespace: cortex-xdr

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: xdr-agent-role
rules:
- apiGroups: [""]
  resources: ["nodes", "pods", "namespaces"]
  verbs: ["get", "list", "watch"]

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: xdr-agent-role-binding-cortex-xdr
subjects:
- kind: ServiceAccount
  name: xdr-agent-user
  namespace: cortex-xdr
roleRef:
  kind: ClusterRole
  name: xdr-agent-role
  apiGroup: rbac.authorization.k8s.io

---

apiVersion: v1
kind: Secret
type: kubernetes.io/dockerconfigjson
metadata:
  name: cortex-docker-secret
  namespace: cortex-xdr
data:
  .dockerconfigjson: eyJhdXRocyI6IHsiaHR0cHM6Ly91cy1jZW50cmFsMS1kb2NrZXIucGtnLmRldiI6IHsidXNlcm5hbWUiOiAiX2pzb25fa2V5IiwgInBhc3N3b3JkIjogIntcbiAgXCJ0eXBlXCI6IFwic2VydmljZV9hY2NvdW50XCIsXG4gIFwicHJvamVjdF9pZFwiOiBcInhkci11cy0xMDAxMzExODk5NDc5XCIsXG4gIFwicHJpdmF0ZV9rZXlfaWRcIjogXCI1MWE3Y2Y4MjIwZGVmNzdiMTdlZTU4YTAwOGYwMzE2OTI2MWU2YzhlXCIsXG4gIFwicHJpdmF0ZV9rZXlcIjogXCItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cXG5NSUlFdmdJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLZ3dnZ1NrQWdFQUFvSUJBUUM4OXBXckpBYTdrNDg5XFxuUU10QmRURjFjVGxNbFFncFNKWS9Zbmt3MEg1VlBmMXNnaTBxRjUrZFZvYnZHOWNmbndYUXJvcW1jYllaU2NVN1xcbnFXaTNYUkFTQTZnREhLMmRjbktpVThvV3ZlOE5SUGlMVXg0R1BacTFTaFJCMS9wZmZZYk1pWGNNbUFDdWtuYTZcXG5QWUg4d2hTanQzS3RnTXFyVVMvN0MyenpVZVFOSG1Vd01ESVVaY2xENVNsZ2FHa1hlWHhFUDJreUJYVURwTUhSXFxuSlk5NC9tOW9SNW5XTFZtVU82VFVwU25VUUtMZkQwNHQwWW5yM3UwVU9DM3A0dlRYUEJiSmlVa1E3eE1odDhRVVxcblZ6aUZKc3BGVlJWZGZMQ2R6MDVXTXpCOXpYME1pV1VqL1RweSthM3NCdCtFbDZDZkdOTkFzMkhyZndjdGRGM1dcXG44enhpYWR4UkFnTUJBQUVDZ2dFQUlaMUMzQ1lsUFhaL0oyQVFtRFViQm4rTStCclYwQlE5eUFwQ01VVVJpQ1BtXFxuSWtpWTlMRXRuMjFPUlJoQWdUdEdhMHcxVlcwS2ZmNmh3NTU4Qm94YlNMMFdSUEZ6ei91Vk9WdXE2amRBNEcwcFxcbndvMFhYUGhWL2xSdWZKVUpVTFhSaGk2WSt5aEtETVA0czJJd0xyQ3V2NzNwUEVTYUtQWWhFU2xENlJmaTk5TW5cXG5COGRFT0ZIOTlCenZWd2VBTlYyRTAraEYyTDlDRC9YbTlES0I4UnFuV00zNWEwTWZVZndrR2hpMWh3U2xWWnRoXFxuNER4OGY2N3lMY1dVTW5hZFVJMm1BY016UldiN0xaamZncjRlQzdxejduUFV0Z21XUlF2cjlNemYrNE5mVVRudVxcbk00M2pSaUVlenJmVVhjNUtrZWQ4MUZTaHkvRElsOEVsY1BVaE0xYUd2UUtCZ1FEeGx0RXptd2d1dkF3K0wwTGlcXG5vZzdDaWMwVGs1ZUZkRWZlMDAzRGRqS05FU1VvbTY0bUt6RUd2eEZFV2grYklPZkE3UUtUL0I1V1pqc0dVWVhqXFxuZEF4M2w4Qkk5WGtxTzIvb29MOGJHWm9RbGVNYUZVT2JFNmMyd3VjT3dpemNqeTB1dVhKLzRlbjRnT214TzF5OFxcbm15MEZLYzlOQ0FRcTlTM3ltQVZoaTdFeVJRS0JnUURJUENUMmRRNmN0LzZHSmxvVmFhaVVNOWZUMU4rc3o4NlJcXG5tWGNRMSsrNk1KY0lWOVBLRnF0MUpIOVFHUmhnVXZtTjNZcXJZZzNVMHM3V3huYm9Qbi9VaGV1OUJBVUdHTzdMXFxudmpmUWI3QmZLd3pzam1RVllLYUU3TUZlV016T1dTZmx4ZkFDOVdkcHdKWFFobUd0anhhdUJHbmVIenUzbm94R1xcbnR4b2V2eXBvblFLQmdRRGVXYTdGem1Samp4TzlrQVlCVEtKRkRrcy9QMUh2dEN3SnUzVVE5eEpqbjJvUnkrY21cXG5uZzRMWllOZzQ0bS9Yek90N3ZXMmVnNzUrakZOQ1c4dS9yb1N3QXBybS9JZW1vSFBHMU9JZjdHNm5obGRBa0VzXFxuMDVQTTVPbUFQZHJJVE1hTEFJZVBoNyt0eGdoUDVKRGZ6ZnBMakVXTllsbGpxRERYM0c3bmJvaHgrUUtCZ1FDVlxcblc2K2lteHhFTUViTjRBdXdEemt0R3lLeG93Y1pTNFRsUEZrQkdtRjZPOFpjOWM1SDN2TVVGUjVXSy9IdjM5VEFcXG5TbkdtZHlTa0RIODIyNkZVaVZJbXY2SmhRbjlRMWdaQnVlaStOS0dWeTNIL2ZoTVBreUdDNDJzMXFmMVRLbFBGXFxuWkFrczI4ckFxbVBWd0hkWjAvTHg2TjdqVGQ3b2ozNUpQVWxoaCt6bFRRS0JnRy9rOCtkTjFlR1Y5ZUFRY01YNVxcblExcUlFOWVpckFMNnZqR0EzZEhrdGZVYnJrZGdXQ0pNRWlML1Bzb2hMYkQ1UEQrYjIramR5U0hVWi9HTDAzVm5cXG5TbHRvY0E0WjhWUDlXRzlHeStoSnR4c1VoaHpjbXB0TXRIaGZLdmhqUFlUTmlycld2WkNIVHBaTkhIaGhHYjg1XFxuUlR6UmJTVGoraWxlZzgrdkcrNUlhTUtKXFxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxcblwiLFxuICBcImNsaWVudF9lbWFpbFwiOiBcInB1bGwtaW1hZ2VAeGRyLXVzLTEwMDEzMTE4OTk0NzkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb21cIixcbiAgXCJjbGllbnRfaWRcIjogXCIxMDA1MjkyNTAyMTEzMzkzMTk3MTBcIixcbiAgXCJhdXRoX3VyaVwiOiBcImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoXCIsXG4gIFwidG9rZW5fdXJpXCI6IFwiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW5cIixcbiAgXCJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmxcIjogXCJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHNcIixcbiAgXCJjbGllbnRfeDUwOV9jZXJ0X3VybFwiOiBcImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvcHVsbC1pbWFnZSU0MHhkci11cy0xMDAxMzExODk5NDc5LmlhbS5nc2VydmljZWFjY291bnQuY29tXCIsXG4gIFwidW5pdmVyc2VfZG9tYWluXCI6IFwiZ29vZ2xlYXBpcy5jb21cIlxufVxuIiwgImVtYWlsIjogInB1bGwtaW1hZ2VAeGRyLXVzLTEwMDEzMTE4OTk0NzkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCAiYXV0aCI6ICJYMnB6YjI1ZmEyVjVPbnNpZEhsd1pTSTZJQ0p6WlhKMmFXTmxYMkZqWTI5MWJuUWlMQ0FpY0hKdmFtVmpkRjlwWkNJNklDSjRaSEl0ZFhNdE1UQXdNVE14TVRnNU9UUTNPU0lzSUNKd2NtbDJZWFJsWDJ0bGVWOXBaQ0k2SUNJMU1XRTNZMlk0TWpJd1pHVm1OemRpTVRkbFpUVTRZVEF3T0dZd016RTJPVEkyTVdVMll6aGxJaXdnSW5CeWFYWmhkR1ZmYTJWNUlqb2dJaTB0TFMwdFFrVkhTVTRnVUZKSlZrRlVSU0JMUlZrdExTMHRMVnh1VFVsSlJYWm5TVUpCUkVGT1FtZHJjV2hyYVVjNWR6QkNRVkZGUmtGQlUwTkNTMmQzWjJkVGEwRm5SVUZCYjBsQ1FWRkRPRGx3VjNKS1FXRTNhelE0T1Z4dVVVMTBRbVJVUmpGalZHeE5iRkZuY0ZOS1dTOVpibXQzTUVnMVZsQm1NWE5uYVRCeFJqVXJaRlp2WW5aSE9XTm1ibmRZVVhKdmNXMWpZbGxhVTJOVk4xeHVjVmRwTTFoU1FWTkJObWRFU0VzeVpHTnVTMmxWT0c5WGRtVTRUbEpRYVV4VmVEUkhVRnB4TVZOb1VrSXhMM0JtWmxsaVRXbFlZMDF0UVVOMWEyNWhObHh1VUZsSU9IZG9VMnAwTTB0MFowMXhjbFZUTHpkRE1ucDZWV1ZSVGtodFZYZE5SRWxWV21Oc1JEVlRiR2RoUjJ0WVpWaDRSVkF5YTNsQ1dGVkVjRTFJVWx4dVNsazVOQzl0T1c5U05XNVhURlp0VlU4MlZGVndVMjVWVVV0TVprUXdOSFF3V1c1eU0zVXdWVTlETTNBMGRsUllVRUppU21sVmExRTNlRTFvZERoUlZWeHVWbnBwUmtwemNFWldVbFprWmt4RFpIb3dOVmROZWtJNWVsZ3dUV2xYVldvdlZIQjVLMkV6YzBKMEswVnNOa05tUjA1T1FYTXlTSEptZDJOMFpFWXpWMXh1T0hwNGFXRmtlRkpCWjAxQ1FVRkZRMmRuUlVGSldqRkRNME5aYkZCWVdpOUtNa0ZSYlVSVllrSnVLMDByUW5KV01FSlJPWGxCY0VOTlZWVlNhVU5RYlZ4dVNXdHBXVGxNUlhSdU1qRlBVbEpvUVdkVWRFZGhNSGN4Vmxjd1MyWm1ObWgzTlRVNFFtOTRZbE5NTUZkU1VFWjZlaTkxVms5V2RYRTJhbVJCTkVjd2NGeHVkMjh3V0ZoUWFGWXZiRkoxWmtwVlNsVk1XRkpvYVRaWkszbG9TMFJOVURSek1rbDNUSEpEZFhZM00zQlFSVk5oUzFCWmFFVlRiRVEyVW1acE9UbE5ibHh1UWpoa1JVOUdTRGs1UW5wMlZuZGxRVTVXTWtVd0syaEdNa3c1UTBRdldHMDVSRXRDT0ZKeGJsZE5NelZoTUUxbVZXWjNhMGRvYVRGb2QxTnNWbHAwYUZ4dU5FUjRPR1kyTjNsTVkxZFZUVzVoWkZWSk1tMUJZMDE2VWxkaU4weGFhbVpuY2pSbFF6ZHhlamR1VUZWMFoyMVhVbEYyY2psTmVtWXJORTVtVlZSdWRWeHVUVFF6YWxKcFJXVjZjbVpWV0dNMVMydGxaRGd4UmxOb2VTOUVTV3c0Uld4alVGVm9UVEZoUjNaUlMwSm5VVVI0YkhSRmVtMTNaM1YyUVhjclREQk1hVnh1YjJjM1EybGpNRlJyTldWR1pFVm1aVEF3TTBSa2FrdE9SVk5WYjIwMk5HMUxla1ZIZG5oR1JWZG9LMkpKVDJaQk4xRkxWQzlDTlZkYWFuTkhWVmxZYWx4dVpFRjRNMnc0UWtrNVdHdHhUekl2YjI5TU9HSkhXbTlSYkdWTllVWlZUMkpGTm1NeWQzVmpUM2RwZW1OcWVUQjFkVmhLTHpSbGJqUm5UMjE0VHpGNU9GeHViWGt3Umt0ak9VNURRVkZ4T1ZNemVXMUJWbWhwTjBWNVVsRkxRbWRSUkVsUVExUXlaRkUyWTNRdk5rZEtiRzlXWVdGcFZVMDVabFF4VGl0emVqZzJVbHh1YlZoalVURXJLelpOU21OSlZqbFFTMFp4ZERGS1NEbFJSMUpvWjFWMmJVNHpXWEZ5V1djelZUQnpOMWQ0Ym1KdlVHNHZWV2hsZFRsQ1FWVkhSMDgzVEZ4dWRtcG1VV0kzUW1aTGQzcHphbTFSVmxsTFlVVTNUVVpsVjAxNlQxZFRabXg0WmtGRE9WZGtjSGRLV0ZGb2JVZDBhbmhoZFVKSGJtVkllblV6Ym05NFIxeHVkSGh2WlhaNWNHOXVVVXRDWjFGRVpWZGhOMFo2YlZKcWFuaFBPV3RCV1VKVVMwcEdSR3R6TDFBeFNIWjBRM2RLZFROVlVUbDRTbXB1TW05U2VTdGpiVnh1Ym1jMFRGcFpUbWMwTkcwdldIcFBkRGQyVnpKbFp6YzFLMnBHVGtOWE9IVXZjbTlUZDBGd2NtMHZTV1Z0YjBoUVJ6RlBTV1kzUnpadWFHeGtRV3RGYzF4dU1EVlFUVFZQYlVGUVpISkpWRTFoVEVGSlpWQm9OeXQwZUdkb1VEVktSR1o2Wm5CTWFrVlhUbGxzYkdweFJFUllNMGMzYm1KdmFIZ3JVVXRDWjFGRFZseHVWellyYVcxNGVFVk5SV0pPTkVGMWQwUjZhM1JIZVV0NGIzZGpXbE0wVkd4UVJtdENSMjFHTms4NFdtTTVZelZJTTNaTlZVWlNOVmRMTDBoMk16bFVRVnh1VTI1SGJXUjVVMnRFU0RneU1qWkdWV2xXU1cxMk5rcG9VVzQ1VVRGbldrSjFaV2tyVGt0SFZua3pTQzltYUUxUWEzbEhRelF5Y3pGeFpqRlVTMnhRUmx4dVdrRnJjekk0Y2tGeGJWQldkMGhrV2pBdlRIZzJUamRxVkdRM2Iyb3pOVXBRVld4b2FDdDZiRlJSUzBKblJ5OXJPQ3RrVGpGbFIxWTVaVUZSWTAxWU5WeHVVVEZ4U1VVNVpXbHlRVXcyZG1wSFFUTmtTR3QwWmxWaWNtdGtaMWREU2sxRmFVd3ZVSE52YUV4aVJEVlFSQ3RpTWl0cVpIbFRTRlZhTDBkTU1ETldibHh1VTJ4MGIyTkJORm80VmxBNVYwYzVSM2tyYUVwMGVITlZhR2g2WTIxd2RFMTBTR2htUzNab2FsQlpWRTVwY25KWGRscERTRlJ3V2s1SVNHaG9SMkk0TlZ4dVVsUjZVbUpUVkdvcmFXeGxaemdyZGtjck5VbGhUVXRLWEc0dExTMHRMVVZPUkNCUVVrbFdRVlJGSUV0RldTMHRMUzB0WEc0aUxDQWlZMnhwWlc1MFgyVnRZV2xzSWpvZ0luQjFiR3d0YVcxaFoyVkFlR1J5TFhWekxURXdNREV6TVRFNE9UazBOemt1YVdGdExtZHpaWEoyYVdObFlXTmpiM1Z1ZEM1amIyMGlMQ0FpWTJ4cFpXNTBYMmxrSWpvZ0lqRXdNRFV5T1RJMU1ESXhNVE16T1RNeE9UY3hNQ0lzSUNKaGRYUm9YM1Z5YVNJNklDSm9kSFJ3Y3pvdkwyRmpZMjkxYm5SekxtZHZiMmRzWlM1amIyMHZieTl2WVhWMGFESXZZWFYwYUNJc0lDSjBiMnRsYmw5MWNta2lPaUFpYUhSMGNITTZMeTl2WVhWMGFESXVaMjl2WjJ4bFlYQnBjeTVqYjIwdmRHOXJaVzRpTENBaVlYVjBhRjl3Y205MmFXUmxjbDk0TlRBNVgyTmxjblJmZFhKc0lqb2dJbWgwZEhCek9pOHZkM2QzTG1kdmIyZHNaV0Z3YVhNdVkyOXRMMjloZFhSb01pOTJNUzlqWlhKMGN5SXNJQ0pqYkdsbGJuUmZlRFV3T1Y5alpYSjBYM1Z5YkNJNklDSm9kSFJ3Y3pvdkwzZDNkeTVuYjI5bmJHVmhjR2x6TG1OdmJTOXliMkp2ZEM5Mk1TOXRaWFJoWkdGMFlTOTROVEE1TDNCMWJHd3RhVzFoWjJVbE5EQjRaSEl0ZFhNdE1UQXdNVE14TVRnNU9UUTNPUzVwWVcwdVozTmxjblpwWTJWaFkyTnZkVzUwTG1OdmJTSXNJQ0oxYm1sMlpYSnpaVjlrYjIxaGFXNGlPaUFpWjI5dloyeGxZWEJwY3k1amIyMGlmUT09In19fQ==

---



---

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: cortex-agent
  namespace: cortex-xdr
  labels:

    app.kubernetes.io/name: cortex-agent
    app.kubernetes.io/part-of: cortex
    app.kubernetes.io/component: agent
    app.kubernetes.io/version: "9.0.0.141085"

spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: cortex-agent

  updateStrategy:
    type: RollingUpdate

  template:
    metadata:
      labels:
        app.kubernetes.io/name: cortex-agent
      annotations:

        container.apparmor.security.beta.kubernetes.io/cortex-agent: unconfined

    spec:
      serviceAccountName: xdr-agent-user

      nodeSelector:
        kubernetes.io/os: linux

      hostNetwork: true
      hostPID: true
      hostIPC: true
      
      tolerations:

      - operator: Exists
        effect: NoSchedule
      - operator: Exists
        effect: PreferNoSchedule
      - operator: Exists
        effect: NoExecute

      containers:
      - name: cortex-agent
        
        image: us-central1-docker.pkg.dev/xdr-us-1001311899479/agent-docker/cortex-agent:9.0.0.141085

        securityContext:
          appArmorProfile:
            type: Unconfined
          capabilities:
            add:
            - SYS_ADMIN
            - SYSLOG
            - SYS_CHROOT
            - SYS_MODULE
            - SYS_PTRACE
            - SYS_RESOURCE
            - SYS_RAWIO
            - DAC_OVERRIDE
            - DAC_READ_SEARCH
            - NET_ADMIN
            - NET_RAW
            - IPC_LOCK
            - FOWNER
            - KILL
            - SETGID
            - SETUID

        env:
        - name: XDR_HOST_ROOT
          value: "/host-fs"
        - name: XDR_POD_INFO
          value: "/var/run/pod-info"
        - name: XDR_CLUSTER_NAME_URL
          value: "metadata2"
        - name: XDR_CLUSTER_NAME
          value: ""
        - name: XDR_VAR_LOG_HOST_PATH
          value: "/var/log"
        - name: XDR_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        

        volumeMounts:

        - name: host-fs
          mountPath: /host-fs
          readOnly: true

        - name: var-log
          mountPath: /var/log

        - name: host-km-directory
          mountPath: /lib/modules

        - name: pod-info
          mountPath: /var/run/pod-info
          readOnly: true

        - name: agent-ids
          mountPath: /etc/traps

        - name: deployment-secrets
          mountPath: /opt/traps/config/deployment
          readOnly: true

        resources:
          requests:
            cpu: "200m"
            memory: "600Mi"
            
          limits:
            memory: "2Gi"
            

      terminationGracePeriodSeconds: 90

      volumes:
      - name: host-fs
        hostPath:
          path: /
          type: Directory

      - name: var-log
        hostPath:
          path: "/var/log"
          type: DirectoryOrCreate
      - name: host-km-directory
        hostPath:
          path: /lib/modules

      - name: pod-info
        downwardAPI:
          items:
          - path: uid
            fieldRef:
              fieldPath: metadata.uid
          - path: name
            fieldRef:
              fieldPath: metadata.name
          - path: labels
            fieldRef:
              fieldPath: metadata.labels
          - path: annotations
            fieldRef:
              fieldPath: metadata.annotations
      - name: agent-ids
        hostPath:
            path: /etc/traps
            type: DirectoryOrCreate

      - name: deployment-secrets
        secret:
          secretName: xdr-agent-deployment
      
      imagePullSecrets:
      - name: cortex-docker-secret